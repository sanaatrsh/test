name: Deploy Laravel to Hostinger

on:
  push:
    branches:
      - master  # أي دفع على فرع master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ جلب الكود من GitHub
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ إعداد PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'   # عدلي حسب نسخة مشروعك
          extensions: mbstring, bcmath, curl, mysql

      # 3️⃣ تثبيت Composer
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      # 4️⃣ إعداد SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: |
            -----BEGIN OPENSSH PRIVATE KEY-----
            b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
            QyNTUxOQAAACAGJ1nR9dIOSAaMSWT0rtqGZKIU8b4mIGOp4wEf3IVvZgAAAKA/V6UaP1el
            GgAAAAtzc2gtZWQyNTUxOQAAACAGJ1nR9dIOSAaMSWT0rtqGZKIU8b4mIGOp4wEf3IVvZg
            AAAEBGEwCbDICm1o7giM5O28lr389qXQpcBm5l3GiWpGNUQQYnWdH10g5IBoxJZPSu2oZk
            ohTxviYgY6njAR/chW9mAAAAFnNhbmFhdHJhc2gwOUBnbWFpbC5jb20BAgMEBQYH
            -----END OPENSSH PRIVATE KEY-----

      # 5️⃣ إضافة Hostinger إلى known_hosts
      - name: Add Hostinger to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 65002 88.223.85.64 >> ~/.ssh/known_hosts

      # 6️⃣ نشر الكود على Hostinger
      - name: Deploy to Hostinger
        run: |
          ssh -p 65002 u629306199@88.223.85.64 "cd domains/peru-horse-360798.hostingersite.com/public_html && git pull origin master && composer install --no-dev --optimize-autoloader && php artisan migrate --force && php artisan config:cache && php artisan route:cache"
